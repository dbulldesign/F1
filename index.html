<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F1 LIVE â€” OpenF1 Workspace</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESET & VARS */
:root {
  --bg: #02040a;
  --ws: #050810;
  --surf: #080e18;
  --surf2: #0c1422;
  --border: #152030;
  --border2: #1e3048;
  --accent: #e8001f;
  --accent2: #ff4500;
  --gold: #f5a623;
  --cyan: #00cfff;
  --green: #00ff88;
  --purple: #c77dff;
  --text: #dde8f5;
  --dim: #4a6580;
  --mid: #7a9ab0;
  --glow-r: rgba(232,0,31,0.5);
  --glow-c: rgba(0,207,255,0.4);
  --win-h: 36px; /* titlebar height */
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR */
#topbar {
  position:fixed;top:0;left:0;right:0;height:48px;z-index:9999;
  background:rgba(2,4,10,0.97);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;padding:0 14px;
  backdrop-filter:blur(20px);
}
.logo {
  font-family:'Orbitron',monospace;font-weight:900;font-size:1rem;
  color:var(--accent);text-shadow:0 0 18px var(--glow-r);letter-spacing:.12em;
  white-space:nowrap;line-height:1;
}
.logo small{display:block;font-size:.52rem;color:var(--dim);letter-spacing:.28em;font-weight:400;margin-top:1px;}

.sep{width:1px;height:24px;background:var(--border2);flex-shrink:0;}

/* Session controls */
.ctrl-lbl{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);letter-spacing:.14em;white-space:nowrap;}
select.ctrl{
  background:var(--surf2);border:1px solid var(--border2);color:var(--text);
  padding:4px 8px;border-radius:3px;font-family:'Rajdhani',sans-serif;font-size:.8rem;
  outline:none;cursor:pointer;max-width:190px;
}
select.ctrl option{background:#0c1422;}
select.ctrl:focus{border-color:var(--cyan);}
.btn{
  background:transparent;border:1px solid var(--border2);color:var(--mid);
  padding:5px 12px;border-radius:3px;font-family:'Orbitron',monospace;font-size:.58rem;
  letter-spacing:.1em;cursor:pointer;white-space:nowrap;transition:all .18s;
}
.btn:hover{border-color:var(--cyan);color:var(--cyan);}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700;}
.btn.primary:hover{background:var(--accent2);border-color:var(--accent2);box-shadow:0 0 14px var(--glow-r);}
.btn.add{background:rgba(0,207,255,.1);border-color:rgba(0,207,255,.4);color:var(--cyan);}
.btn.add:hover{background:rgba(0,207,255,.18);box-shadow:0 0 12px var(--glow-c);}

/* Tiling buttons */
.tile-group{display:flex;gap:4px;}
.tile-btn{
  background:var(--surf2);border:1px solid var(--border);color:var(--dim);
  width:28px;height:28px;border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:.75rem;transition:all .15s;flex-shrink:0;
}
.tile-btn:hover{border-color:var(--cyan);color:var(--cyan);}

.live-pip{
  display:flex;align-items:center;gap:5px;
  background:rgba(232,0,31,.1);border:1px solid rgba(232,0,31,.35);
  padding:4px 9px;border-radius:3px;font-family:'Orbitron',monospace;font-size:.58rem;letter-spacing:.12em;color:var(--accent);
}
.pip-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:blink 1.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

#status-chip{font-family:'Share Tech Mono',monospace;font-size:.62rem;color:var(--dim);white-space:nowrap;max-width:220px;overflow:hidden;text-overflow:ellipsis;}
#status-chip.ok{color:var(--green);}
#status-chip.err{color:var(--accent);}

/* spacer */
.flex1{flex:1;min-width:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE */
#workspace {
  position:fixed;top:48px;left:0;right:0;bottom:0;
  background:var(--ws);overflow:hidden;
  background-image:
    radial-gradient(ellipse at 20% 60%, rgba(232,0,31,.03) 0%, transparent 55%),
    radial-gradient(ellipse at 80% 20%, rgba(0,207,255,.025) 0%, transparent 50%),
    linear-gradient(rgba(21,32,48,.4) 1px, transparent 1px),
    linear-gradient(90deg, rgba(21,32,48,.4) 1px, transparent 1px);
  background-size:100% 100%, 100% 100%, 40px 40px, 40px 40px;
}

#workspace.drag-active{cursor:grabbing!important;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WINDOWS */
.win {
  position:absolute;
  background:var(--surf);
  border:1px solid var(--border2);
  border-radius:6px;
  box-shadow:0 8px 40px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.03);
  display:flex;flex-direction:column;
  min-width:260px;min-height:160px;
  transition:box-shadow .15s;
  overflow:hidden;
}
.win:hover{box-shadow:0 12px 50px rgba(0,0,0,.8), 0 0 0 1px rgba(0,207,255,.08);}
.win.focused{
  border-color:rgba(0,207,255,.3);
  box-shadow:0 16px 60px rgba(0,0,0,.9), 0 0 0 1px rgba(0,207,255,.15), 0 0 20px rgba(0,207,255,.05);
  z-index:100!important;
}
.win.minimized .win-body{display:none!important;}
.win.minimized{min-height:0!important;}

/* Titlebar */
.win-title {
  height:var(--win-h);min-height:var(--win-h);
  display:flex;align-items:center;gap:8px;
  padding:0 10px 0 12px;
  background:rgba(0,0,0,.3);
  border-bottom:1px solid var(--border);
  cursor:grab;user-select:none;flex-shrink:0;
}
.win-title:active{cursor:grabbing;}
.win-type-icon{font-size:.9rem;flex-shrink:0;}
.win-type-name{
  font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.14em;
  color:var(--mid);text-transform:uppercase;flex:1;min-width:0;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.win-controls{display:flex;gap:4px;flex-shrink:0;}
.wc-btn{
  width:13px;height:13px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:.5rem;
  transition:filter .15s;flex-shrink:0;
}
.wc-btn:hover{filter:brightness(1.4);}
.wc-close{background:#e8001f;}
.wc-min{background:#f5a623;}
.wc-max{background:#00c853;}

/* Type selector inside titlebar */
.win-type-sel{
  background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--text);
  padding:2px 6px;border-radius:3px;font-family:'Orbitron',monospace;font-size:.52rem;
  letter-spacing:.08em;outline:none;cursor:pointer;max-width:130px;
}
.win-type-sel option{background:#0c1422;}

/* Body */
.win-body{flex:1;overflow:auto;position:relative;min-height:0;}
.win-body::-webkit-scrollbar{width:4px;height:4px;}
.win-body::-webkit-scrollbar-track{background:transparent;}
.win-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* Resize handle */
.win-resize{
  position:absolute;right:0;bottom:0;width:16px;height:16px;cursor:se-resize;
  display:flex;align-items:flex-end;justify-content:flex-end;padding:3px;
  opacity:.35;transition:opacity .15s;
}
.win-resize:hover{opacity:.8;}
.win-resize svg{width:9px;height:9px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PANEL CONTENTS */
.p-empty{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;gap:8px;color:var(--dim);text-align:center;padding:20px;
}
.p-empty-icon{font-size:2rem;opacity:.2;}
.p-empty-title{font-family:'Orbitron',monospace;font-size:.65rem;letter-spacing:.15em;}
.p-empty-sub{font-size:.8rem;max-width:220px;line-height:1.5;}

/* Timing table */
.t-table{width:100%;border-collapse:collapse;font-family:'Share Tech Mono',monospace;font-size:.75rem;}
.t-table th{padding:6px 10px;text-align:left;color:var(--dim);font-size:.58rem;letter-spacing:.14em;border-bottom:1px solid var(--border);background:rgba(0,0,0,.18);white-space:nowrap;}
.t-table td{padding:7px 10px;border-bottom:1px solid rgba(21,32,48,.6);vertical-align:middle;}
.t-table tr:hover td{background:rgba(255,255,255,.018);}
.pos{font-family:'Orbitron',monospace;font-weight:700;font-size:.82rem;color:var(--mid);min-width:22px;display:inline-block;}
.p1c{color:var(--gold)!important;} .p2c{color:#bbb!important;} .p3c{color:#cd7f32!important;}
.d-num{display:inline-block;padding:1px 6px;border-radius:3px;font-weight:700;font-size:.72rem;min-width:28px;text-align:center;}
.d-name{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:.9rem;}
.d-abbr{font-family:'Orbitron',monospace;font-size:.62rem;font-weight:700;}
.dim{color:var(--dim);}
.fastest{color:var(--purple)!important;}
.drs-on{background:rgba(0,255,136,.12);color:var(--green);border:1px solid rgba(0,255,136,.3);padding:1px 5px;border-radius:2px;font-size:.55rem;}

/* Tyres */
.tyre{display:inline-flex;width:18px;height:18px;border-radius:50%;font-size:.5rem;align-items:center;justify-content:center;font-weight:900;flex-shrink:0;}
.tyre-soft{background:var(--accent);color:#fff;}
.tyre-medium{background:var(--gold);color:#000;}
.tyre-hard{background:#ddd;color:#000;}
.tyre-inter{background:var(--green);color:#000;}
.tyre-wet{background:var(--cyan);color:#000;}
.tyre-unknown{background:var(--surf2);color:var(--dim);border:1px solid var(--border);}

/* Telemetry cards */
.telem-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;padding:12px;}
.d-card{background:var(--surf2);border:1px solid var(--border);border-radius:5px;overflow:hidden;}
.d-card-hdr{padding:8px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);}
.d-card-num{font-family:'Orbitron',monospace;font-weight:900;font-size:1.1rem;}
.d-card-info{flex:1;}
.d-card-name{font-weight:700;font-size:.88rem;}
.d-card-team{font-size:.68rem;color:var(--dim);}
.d-card-pos{font-family:'Orbitron',monospace;font-size:1.2rem;font-weight:900;color:var(--dim);}
.bars{padding:10px 12px;display:flex;flex-direction:column;gap:6px;}
.bar-row{display:flex;flex-direction:column;gap:2px;}
.bar-lbl{display:flex;justify-content:space-between;font-size:.62rem;color:var(--dim);font-family:'Share Tech Mono',monospace;}
.bar-val{color:var(--text);font-weight:600;}
.bar-track{height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.bar-fill{height:100%;border-radius:2px;transition:width .5s ease;}
.bt{background:linear-gradient(90deg,var(--green),#00ff88aa);}
.bb{background:linear-gradient(90deg,var(--accent),#ff4500);}
.bg{background:linear-gradient(90deg,var(--cyan),#00cfffaa);}
.br{background:linear-gradient(90deg,var(--gold),var(--accent2));}
.d-stats{padding:0 12px 10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;}
.s-box{background:var(--surf);border:1px solid var(--border);border-radius:3px;padding:5px 6px;text-align:center;}
.s-val{font-family:'Orbitron',monospace;font-size:.78rem;font-weight:700;}
.s-lbl{font-size:.52rem;color:var(--dim);letter-spacing:.08em;text-transform:uppercase;margin-top:1px;}

/* Standings */
.stand-row{display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid var(--border);}
.stand-row:hover{background:rgba(255,255,255,.015);}
.pts-track{flex:1;height:2px;background:var(--border);border-radius:2px;overflow:hidden;}
.pts-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--gold));border-radius:2px;}
.pts-val{font-family:'Orbitron',monospace;font-size:.78rem;font-weight:700;color:var(--gold);min-width:38px;text-align:right;}

/* Weather */
.wx-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;padding:12px;}
.wx-box{background:var(--surf2);border:1px solid var(--border);border-radius:5px;padding:12px;text-align:center;}
.wx-icon{font-size:1.5rem;margin-bottom:3px;}
.wx-lbl{font-size:.55rem;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;}
.wx-val{font-family:'Orbitron',monospace;font-size:.95rem;font-weight:700;margin-top:1px;}

/* Race control */
.rc-item{padding:8px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;}
.rc-time{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);white-space:nowrap;margin-top:1px;}
.rc-msg{font-size:.8rem;line-height:1.4;}
.rc-cat{font-size:.55rem;padding:1px 5px;border-radius:2px;letter-spacing:.07em;white-space:nowrap;}
.rc-flag{background:rgba(245,166,35,.18);color:var(--gold);border:1px solid rgba(245,166,35,.3);}
.rc-inc{background:rgba(232,0,31,.14);color:var(--accent);border:1px solid rgba(232,0,31,.3);}
.rc-info{background:rgba(0,207,255,.1);color:var(--cyan);border:1px solid rgba(0,207,255,.2);}

/* Laps */
.lap-hdr{padding:8px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.15);}
.drv-sel{background:var(--surf2);border:1px solid var(--border);color:var(--text);padding:3px 7px;border-radius:3px;font-family:'Rajdhani',sans-serif;font-size:.78rem;outline:none;}
.drv-sel option{background:#0c1422;}

/* Track canvas */
.track-wrap{position:relative;width:100%;height:100%;background:#030710;overflow:hidden;}
.track-canvas{display:block;width:100%;height:100%;cursor:grab;}
.track-canvas:active{cursor:grabbing;}
.track-ctrl{position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:4px;z-index:10;}
.t-zbtn{background:rgba(8,14,24,.85);border:1px solid var(--border2);color:var(--mid);width:24px;height:24px;border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.85rem;transition:all .15s;}
.t-zbtn:hover{border-color:var(--cyan);color:var(--cyan);}
.track-legend{position:absolute;bottom:8px;left:8px;display:flex;flex-wrap:wrap;gap:5px;max-width:calc(100% - 16px);}
.leg-item{display:flex;align-items:center;gap:4px;font-size:.62rem;color:var(--mid);font-family:'Share Tech Mono',monospace;background:rgba(2,4,10,.75);padding:2px 6px;border-radius:3px;}
.leg-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.track-loading{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:rgba(3,7,16,.9);z-index:5;}
.loader{width:28px;height:28px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.track-loading-t{font-family:'Orbitron',monospace;font-size:.65rem;letter-spacing:.15em;color:var(--dim);}

/* Scroll */
.scr{overflow:auto;height:100%;}
.scr::-webkit-scrollbar{width:4px;height:4px;}
.scr::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PANEL PICKER MODAL */
#picker-modal{
  display:none;position:fixed;inset:0;z-index:99999;
  background:rgba(2,4,10,.85);backdrop-filter:blur(8px);
  align-items:center;justify-content:center;
}
#picker-modal.open{display:flex;}
.picker-box{
  background:var(--surf);border:1px solid var(--border2);border-radius:8px;
  padding:20px;width:380px;max-width:95vw;
}
.picker-title{font-family:'Orbitron',monospace;font-size:.75rem;letter-spacing:.2em;color:var(--dim);margin-bottom:14px;}
.picker-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.picker-item{
  background:var(--surf2);border:1px solid var(--border);border-radius:5px;
  padding:12px;cursor:pointer;transition:all .18s;
  display:flex;align-items:center;gap:10px;
}
.picker-item:hover{border-color:rgba(0,207,255,.4);background:rgba(0,207,255,.05);}
.picker-item-icon{font-size:1.2rem;}
.picker-item-name{font-family:'Orbitron',monospace;font-size:.58rem;letter-spacing:.1em;color:var(--mid);}
.picker-cancel{margin-top:12px;width:100%;background:transparent;border:1px solid var(--border);color:var(--dim);padding:8px;border-radius:4px;font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.1em;cursor:pointer;transition:all .15s;}
.picker-cancel:hover{border-color:var(--accent);color:var(--accent);}
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <div class="logo">F1 LIVE<small>OPENF1 WORKSPACE</small></div>
  <div class="sep"></div>
  <span class="ctrl-lbl">YEAR</span>
  <select class="ctrl" id="sel-year" style="max-width:72px;">
    <option value="2025">2025</option>
    <option value="2024">2024</option>
    <option value="2023">2023</option>
    <option value="2022">2022</option>
  </select>
  <span class="ctrl-lbl">SESSION</span>
  <select class="ctrl" id="sel-session" style="max-width:200px;"><option value="">Load yearâ€¦</option></select>
  <button class="btn primary" onclick="loadSession()">LOAD</button>
  <div class="sep"></div>
  <!-- Tiling -->
  <span class="ctrl-lbl">TILE</span>
  <div class="tile-group">
    <div class="tile-btn" onclick="tileWindows('grid')" title="Grid tile">âŠ</div>
    <div class="tile-btn" onclick="tileWindows('cols')" title="Columns">â«¶</div>
    <div class="tile-btn" onclick="tileWindows('rows')" title="Rows">â‹¯</div>
    <div class="tile-btn" onclick="cascadeWindows()" title="Cascade">â</div>
  </div>
  <div class="sep"></div>
  <button class="btn add" onclick="openPicker()">+ PANEL</button>
  <div class="flex1"></div>
  <div class="live-pip"><div class="pip-dot"></div>LIVE</div>
  <div id="status-chip">Ready â€” load a session</div>
</div>

<!-- WORKSPACE -->
<div id="workspace" id="ws"></div>

<!-- PANEL PICKER MODAL -->
<div id="picker-modal">
  <div class="picker-box">
    <div class="picker-title">ADD PANEL TO WORKSPACE</div>
    <div class="picker-grid" id="picker-grid"></div>
    <button class="picker-cancel" onclick="closePicker()">CANCEL</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PANEL DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PANELS = [
  { id:'timing',      icon:'ğŸ', name:'TIMING TOWER',       desc:'Live race positions' },
  { id:'track',       icon:'ğŸ—º', name:'TRACK MAP',           desc:'Live GPS driver positions' },
  { id:'telemetry',   icon:'ğŸ“Š', name:'TELEMETRY',           desc:'Throttle, brake, speed, RPM' },
  { id:'standings',   icon:'ğŸ†', name:'STANDINGS',           desc:'Championship tables' },
  { id:'laps',        icon:'â±', name:'LAP TIMES',           desc:'Full lap & sector data' },
  { id:'pitstops',    icon:'ğŸ”§', name:'PIT STOPS',           desc:'Pit stop history' },
  { id:'weather',     icon:'ğŸŒ¤', name:'WEATHER',             desc:'Track conditions' },
  { id:'racecontrol', icon:'ğŸ“»', name:'RACE CONTROL',        desc:'Flags & messages' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = 'https://api.openf1.org/v1';
let G = {
  sessionKey:null, locationName:'', year:2025,
  drivers:{}, positions:[], locationData:[], carData:{},
  laps:[], pits:[], weather:[], raceControl:[],
  driverStandings:[], teamStandings:[],
  locationLoaded:false, trackPts:[], driverLocs:{},
  autoInterval:null,
};

// Window manager
let WM = {
  windows: [],        // [{id, type, el, canvas:{scale,offX,offY,panX,panY}, lapFilter}]
  zTop: 10,
  nextId: 1,
  // drag state
  drag: null,         // {winId, startX, startY, origLeft, origTop}
  resize: null,       // {winId, startX, startY, origW, origH}
};

const TEAM_COLORS = {
  'Red Bull Racing':'#3671C6','Ferrari':'#E8001F','Mercedes':'#27F4D2',
  'McLaren':'#FF8000','Aston Martin':'#358C75','Alpine':'#FF87BC',
  'Williams':'#64C4FF','RB':'#6692FF','Haas F1 Team':'#B6BABD','Kick Sauber':'#52E252',
};
const teamColor = t => { for(const[k,v] of Object.entries(TEAM_COLORS)) if((t||'').includes(k)) return v; return '#777'; };
const driverColor = d => d?.team_colour ? '#'+d.team_colour : teamColor(d?.team_name);
const fmtT = s => { if(!s) return 'â€”'; const m=Math.floor(s/60),r=(s%60).toFixed(3); return m>0?`${m}:${r<10?'0'+r:r}`:String(parseFloat(r.toFixed(3))); };

function setStatus(msg,cls='') {
  const el = document.getElementById('status-chip');
  el.textContent = msg; el.className = cls;
}

async function apiFetch(ep, params={}) {
  const url = new URL(API+ep);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSessions() {
  const year = document.getElementById('sel-year').value;
  G.year = parseInt(year);
  setStatus('Loading sessionsâ€¦');
  try {
    const sessions = await apiFetch('/sessions', {year});
    const sel = document.getElementById('sel-session');
    sel.innerHTML = '';
    const byMtg = {};
    sessions.forEach(s => {
      if(!byMtg[s.meeting_key]) byMtg[s.meeting_key]={name:s.meeting_name||s.location,sessions:[]};
      byMtg[s.meeting_key].sessions.push(s);
    });
    Object.values(byMtg).reverse().forEach(m => {
      const g = document.createElement('optgroup'); g.label = m.name;
      m.sessions.forEach(s => {
        const o = document.createElement('option');
        o.value = s.session_key;
        o.textContent = s.session_name+(s.date_start?' ('+s.date_start.slice(0,10)+')':'');
        o.dataset.location = s.location||s.meeting_name||'';
        g.appendChild(o);
      });
      sel.appendChild(g);
    });
    setStatus(sessions.length+' sessions found','ok');
  } catch(e) { setStatus('Error: '+e.message,'err'); }
}

document.getElementById('sel-year').addEventListener('change', loadSessions);

async function loadSession() {
  const sel = document.getElementById('sel-session');
  const opt = sel.selectedOptions[0];
  if(!opt||!opt.value){setStatus('Select a session','err');return;}
  G.sessionKey = parseInt(opt.value);
  G.locationName = opt.dataset.location||'';
  G.locationLoaded = false; G.trackPts = []; G.driverLocs = {};
  if(G.autoInterval) clearInterval(G.autoInterval);
  await fetchAll();
  G.autoInterval = setInterval(()=>fetchAll(true), 30000);
}

async function fetchAll(silent=false) {
  if(!G.sessionKey) return;
  if(!silent) setStatus('Loading dataâ€¦');
  try {
    const [drv,pos,car,laps,pits,wx,rc] = await Promise.allSettled([
      apiFetch('/drivers',{session_key:G.sessionKey}),
      apiFetch('/position',{session_key:G.sessionKey}),
      apiFetch('/car_data',{session_key:G.sessionKey}),
      apiFetch('/laps',{session_key:G.sessionKey}),
      apiFetch('/pit',{session_key:G.sessionKey}),
      apiFetch('/weather',{session_key:G.sessionKey}),
      apiFetch('/race_control',{session_key:G.sessionKey}),
    ]);
    if(drv.status==='fulfilled'){G.drivers={};drv.value.forEach(d=>G.drivers[d.driver_number]=d);}
    if(pos.status==='fulfilled') G.positions=pos.value;
    if(car.status==='fulfilled') G.carData=latestBy(car.value,'driver_number');
    if(laps.status==='fulfilled') G.laps=laps.value;
    if(pits.status==='fulfilled') G.pits=pits.value;
    if(wx.status==='fulfilled') G.weather=wx.value;
    if(rc.status==='fulfilled') G.raceControl=rc.value;
    const [dS,tS] = await Promise.allSettled([
      apiFetch('/championship_drivers',{session_key:G.sessionKey}),
      apiFetch('/championship_teams',{session_key:G.sessionKey}),
    ]);
    if(dS.status==='fulfilled') G.driverStandings=dS.value;
    if(tS.status==='fulfilled') G.teamStandings=tS.value;
    if(!G.locationLoaded) fetchLocationData();
    else { buildDriverLocs(); refreshTrackWindows(); }
    refreshAllWindows();
    setStatus('Updated '+new Date().toLocaleTimeString(),'ok');
  } catch(e){setStatus('Error: '+e.message,'err');}
}

async function fetchLocationData() {
  setStatus('Fetching GPS track dataâ€¦');
  try {
    G.locationData = await apiFetch('/location',{session_key:G.sessionKey});
    G.locationLoaded = true;
    buildTrackOutline();
    buildDriverLocs();
    refreshTrackWindows();
    setStatus('Track map ready','ok');
  } catch(e){ setStatus('Location data unavailable',''); }
}

function latestBy(arr,key) {
  const m={};
  arr.forEach(d=>{if(!m[d[key]]||d.date>m[d[key]].date)m[d[key]]=d;});
  return m;
}

function getLatestPositions() {
  const m={};
  G.positions.forEach(p=>{if(!m[p.driver_number]||p.date>m[p.driver_number].date)m[p.driver_number]=p;});
  return Object.values(m).sort((a,b)=>a.position-b.position);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRACK DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTrackOutline() {
  if(!G.locationData.length) return;
  const groups={};
  G.locationData.forEach(p=>{
    if(p.x===undefined||(p.x===0&&p.y===0)) return;
    if(!groups[p.driver_number]) groups[p.driver_number]=[];
    groups[p.driver_number].push(p);
  });
  let best=null,bestN=0;
  Object.entries(groups).forEach(([dn,pts])=>{if(pts.length>bestN){bestN=pts.length;best=dn;}});
  if(!best) return;
  const raw=groups[best].sort((a,b)=>a.date<b.date?-1:1)
    .filter((p,i,a)=>i===0||Math.hypot(p.x-a[i-1].x,p.y-a[i-1].y)>1.5);
  const W=8;
  G.trackPts=raw.map((p,i)=>{
    const sl=raw.slice(Math.max(0,i-W),Math.min(raw.length,i+W+1));
    return{x:sl.reduce((s,q)=>s+q.x,0)/sl.length,y:sl.reduce((s,q)=>s+q.y,0)/sl.length};
  });
}

function buildDriverLocs() {
  if(!G.locationData.length) return;
  const latLoc={};
  G.locationData.forEach(p=>{
    if(p.x===undefined||(p.x===0&&p.y===0)) return;
    if(!latLoc[p.driver_number]||p.date>latLoc[p.driver_number].date) latLoc[p.driver_number]=p;
  });
  const positions=getLatestPositions();
  G.driverLocs={};
  positions.forEach(p=>{
    const loc=latLoc[p.driver_number]; if(!loc) return;
    const d=G.drivers[p.driver_number]||{};
    G.driverLocs[p.driver_number]={x:loc.x,y:loc.y,color:driverColor(d),abbr:d.name_acronym||'#'+p.driver_number,pos:p.position};
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WINDOW MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPicker() { document.getElementById('picker-modal').classList.add('open'); }
function closePicker() { document.getElementById('picker-modal').classList.remove('open'); }

function buildPicker() {
  const grid = document.getElementById('picker-grid');
  grid.innerHTML = PANELS.map(p=>`
    <div class="picker-item" onclick="spawnWindow('${p.id}');closePicker();">
      <span class="picker-item-icon">${p.icon}</span>
      <div>
        <div class="picker-item-name">${p.name}</div>
        <div style="font-size:.65rem;color:var(--dim);margin-top:2px;">${p.desc}</div>
      </div>
    </div>
  `).join('');
}

function spawnWindow(type, x, y, w, h) {
  const ws = document.getElementById('workspace');
  const wsW = ws.clientWidth, wsH = ws.clientHeight;
  const winW = w || Math.min(520, wsW * 0.45);
  const winH = h || Math.min(420, wsH * 0.55);
  const winX = x !== undefined ? x : 60 + (WM.windows.length % 5) * 28;
  const winY = y !== undefined ? y : 60 + (WM.windows.length % 4) * 28;

  const pDef = PANELS.find(p=>p.id===type)||PANELS[0];
  const id = WM.nextId++;

  const el = document.createElement('div');
  el.className = 'win';
  el.dataset.winId = id;
  el.style.cssText = `left:${winX}px;top:${winY}px;width:${winW}px;height:${winH}px;z-index:${++WM.zTop};`;

  // Type selector options
  const selOpts = PANELS.map(p=>`<option value="${p.id}" ${p.id===type?'selected':''}>${p.icon} ${p.name}</option>`).join('');

  el.innerHTML = `
    <div class="win-title" data-drag="${id}">
      <span class="win-type-icon">${pDef.icon}</span>
      <select class="win-type-sel" onchange="changeWinType(${id},this.value)" onclick="event.stopPropagation()">
        ${selOpts}
      </select>
      <div class="win-controls">
        <div class="wc-btn wc-min" title="Minimise" onclick="toggleMinimize(${id})"></div>
        <div class="wc-btn wc-max" title="Maximise" onclick="maximizeWin(${id})"></div>
        <div class="wc-btn wc-close" title="Close" onclick="closeWin(${id})"></div>
      </div>
    </div>
    <div class="win-body" id="wb-${id}"></div>
    <div class="win-resize" data-resize="${id}">
      <svg viewBox="0 0 9 9" fill="none">
        <line x1="3" y1="9" x2="9" y2="3" stroke="#4a6580" stroke-width="1.5"/>
        <line x1="6" y1="9" x2="9" y2="6" stroke="#4a6580" stroke-width="1.5"/>
      </svg>
    </div>
  `;

  ws.appendChild(el);

  const winObj = {
    id, type, el,
    trackState: { scale:1, offX:0, offY:0, panX:0, panY:0, inited:false },
    lapFilter: '',
    minimized: false,
    prevGeom: null,
  };
  WM.windows.push(winObj);

  focusWin(id);
  renderWindow(id);

  // If track type and data already loaded, init track
  if(type==='track' && G.trackPts.length>0) {
    setTimeout(()=>initTrackForWindow(id),50);
  }

  return winObj;
}

function getWin(id) { return WM.windows.find(w=>w.id===id); }

function focusWin(id) {
  WM.windows.forEach(w=>w.el.classList.remove('focused'));
  const w = getWin(id);
  if(!w) return;
  w.el.style.zIndex = ++WM.zTop;
  w.el.classList.add('focused');
}

function closeWin(id) {
  const w = getWin(id);
  if(!w) return;
  w.el.remove();
  WM.windows = WM.windows.filter(x=>x.id!==id);
}

function toggleMinimize(id) {
  const w = getWin(id);
  if(!w) return;
  w.minimized = !w.minimized;
  w.el.classList.toggle('minimized', w.minimized);
}

function maximizeWin(id) {
  const w = getWin(id);
  if(!w) return;
  const ws = document.getElementById('workspace');
  if(w.prevGeom) {
    // restore
    const g = w.prevGeom;
    w.el.style.left = g.left; w.el.style.top = g.top;
    w.el.style.width = g.width; w.el.style.height = g.height;
    w.prevGeom = null;
  } else {
    w.prevGeom = { left:w.el.style.left, top:w.el.style.top, width:w.el.style.width, height:w.el.style.height };
    w.el.style.left='4px'; w.el.style.top='4px';
    w.el.style.width=(ws.clientWidth-8)+'px'; w.el.style.height=(ws.clientHeight-8)+'px';
    if(w.type==='track') setTimeout(()=>initTrackForWindow(id),50);
  }
  focusWin(id);
}

function changeWinType(id, type) {
  const w = getWin(id);
  if(!w) return;
  w.type = type;
  const pDef = PANELS.find(p=>p.id===type);
  // Update icon in title
  w.el.querySelector('.win-type-icon').textContent = pDef.icon;
  renderWindow(id);
  if(type==='track' && G.trackPts.length>0) setTimeout(()=>initTrackForWindow(id),50);
}

// Drag
document.getElementById('workspace').addEventListener('mousedown', e => {
  const dragTarget = e.target.closest('[data-drag]');
  const resizeTarget = e.target.closest('[data-resize]');

  if(dragTarget) {
    e.preventDefault();
    const id = parseInt(dragTarget.dataset.drag);
    const w = getWin(id); if(!w) return;
    focusWin(id);
    const rect = w.el.getBoundingClientRect();
    const ws = document.getElementById('workspace').getBoundingClientRect();
    WM.drag = { id, startX:e.clientX, startY:e.clientY, origLeft:rect.left-ws.left, origTop:rect.top-ws.top };
  }
  if(resizeTarget) {
    e.preventDefault();
    const id = parseInt(resizeTarget.dataset.resize);
    const w = getWin(id); if(!w) return;
    focusWin(id);
    WM.resize = { id, startX:e.clientX, startY:e.clientY, origW:w.el.offsetWidth, origH:w.el.offsetHeight };
  }
  // Focus on any click inside window
  const winEl = e.target.closest('.win');
  if(winEl) focusWin(parseInt(winEl.dataset.winId));
});

document.addEventListener('mousemove', e => {
  if(WM.drag) {
    const w = getWin(WM.drag.id); if(!w) return;
    const dx=e.clientX-WM.drag.startX, dy=e.clientY-WM.drag.startY;
    const ws = document.getElementById('workspace');
    const newL = Math.max(0,Math.min(ws.clientWidth-100, WM.drag.origLeft+dx));
    const newT = Math.max(0,Math.min(ws.clientHeight-40, WM.drag.origTop+dy));
    w.el.style.left=newL+'px'; w.el.style.top=newT+'px';
  }
  if(WM.resize) {
    const w = getWin(WM.resize.id); if(!w) return;
    const dx=e.clientX-WM.resize.startX, dy=e.clientY-WM.resize.startY;
    const newW = Math.max(260, WM.resize.origW+dx);
    const newH = Math.max(160, WM.resize.origH+dy);
    w.el.style.width=newW+'px'; w.el.style.height=newH+'px';
    if(w.type==='track') redrawTrackForWindow(w.id);
  }
});

document.addEventListener('mouseup', () => {
  WM.drag = null; WM.resize = null;
});

// Touch drag
document.getElementById('workspace').addEventListener('touchstart', e => {
  const dragTarget = e.target.closest('[data-drag]');
  if(dragTarget) {
    const id = parseInt(dragTarget.dataset.drag);
    const w = getWin(id); if(!w) return;
    focusWin(id);
    const rect = w.el.getBoundingClientRect();
    const ws = document.getElementById('workspace').getBoundingClientRect();
    WM.drag = { id, startX:e.touches[0].clientX, startY:e.touches[0].clientY, origLeft:rect.left-ws.left, origTop:rect.top-ws.top };
  }
},{passive:true});
document.addEventListener('touchmove', e => {
  if(WM.drag) {
    const w = getWin(WM.drag.id); if(!w) return;
    const dx=e.touches[0].clientX-WM.drag.startX, dy=e.touches[0].clientY-WM.drag.startY;
    const ws = document.getElementById('workspace');
    w.el.style.left=Math.max(0,WM.drag.origLeft+dx)+'px';
    w.el.style.top=Math.max(0,WM.drag.origTop+dy)+'px';
  }
},{passive:true});
document.addEventListener('touchend', ()=>{WM.drag=null;},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TILING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tileWindows(mode) {
  const visible = WM.windows.filter(w=>!w.minimized);
  if(!visible.length) return;
  const ws = document.getElementById('workspace');
  const W=ws.clientWidth, H=ws.clientHeight;
  const n=visible.length;
  const pad=6;

  if(mode==='grid') {
    const cols=Math.ceil(Math.sqrt(n)), rows=Math.ceil(n/cols);
    const tw=Math.floor((W-pad*(cols+1))/cols), th=Math.floor((H-pad*(rows+1))/rows);
    visible.forEach((w,i)=>{
      const c=i%cols, r=Math.floor(i/cols);
      w.el.style.left=(pad+c*(tw+pad))+'px'; w.el.style.top=(pad+r*(th+pad))+'px';
      w.el.style.width=tw+'px'; w.el.style.height=th+'px';
    });
  } else if(mode==='cols') {
    const tw=Math.floor((W-pad*(n+1))/n);
    visible.forEach((w,i)=>{
      w.el.style.left=(pad+i*(tw+pad))+'px'; w.el.style.top=pad+'px';
      w.el.style.width=tw+'px'; w.el.style.height=(H-pad*2)+'px';
    });
  } else if(mode==='rows') {
    const th=Math.floor((H-pad*(n+1))/n);
    visible.forEach((w,i)=>{
      w.el.style.left=pad+'px'; w.el.style.top=(pad+i*(th+pad))+'px';
      w.el.style.width=(W-pad*2)+'px'; w.el.style.height=th+'px';
    });
  }
  // Re-init track canvases
  visible.forEach(w=>{
    if(w.type==='track') setTimeout(()=>initTrackForWindow(w.id),80);
  });
}

function cascadeWindows() {
  const visible = WM.windows.filter(w=>!w.minimized);
  const ws = document.getElementById('workspace');
  const baseW=Math.min(540,ws.clientWidth*0.6), baseH=Math.min(420,ws.clientHeight*0.65);
  visible.forEach((w,i)=>{
    w.el.style.left=(20+i*32)+'px'; w.el.style.top=(20+i*32)+'px';
    w.el.style.width=baseW+'px'; w.el.style.height=baseH+'px';
    focusWin(w.id);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER WINDOWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshAllWindows() {
  WM.windows.forEach(w=>renderWindow(w.id));
}

function refreshTrackWindows() {
  WM.windows.filter(w=>w.type==='track').forEach(w=>{
    if(!w.trackState.inited) initTrackForWindow(w.id);
    else redrawTrackForWindow(w.id);
  });
}

function renderWindow(id) {
  const w = getWin(id); if(!w) return;
  const body = document.getElementById('wb-'+id);
  if(!body) return;
  switch(w.type) {
    case 'timing':      renderTiming(body); break;
    case 'track':       renderTrackPanel(body, w); break;
    case 'telemetry':   renderTelemetry(body); break;
    case 'standings':   renderStandings(body); break;
    case 'laps':        renderLaps(body, w); break;
    case 'pitstops':    renderPits(body); break;
    case 'weather':     renderWeather(body); break;
    case 'racecontrol': renderRaceControl(body); break;
    default: body.innerHTML='<div class="p-empty"><div class="p-empty-title">UNKNOWN PANEL</div></div>';
  }
}

function noData(icon,title,sub='') {
  return `<div class="p-empty"><div class="p-empty-icon">${icon}</div><div class="p-empty-title">${title}</div>${sub?`<div class="p-empty-sub">${sub}</div>`:''}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTiming(body) {
  const positions=getLatestPositions();
  if(!positions.length){body.innerHTML=noData('ğŸ','NO SESSION LOADED','Load a session to see timing data');return;}
  const bestLaps={};
  G.laps.forEach(l=>{if(l.lap_duration&&(!bestLaps[l.driver_number]||l.lap_duration<bestLaps[l.driver_number]))bestLaps[l.driver_number]=l.lap_duration;});
  const overallBest=Math.min(...Object.values(bestLaps).filter(Boolean));
  const curLap={};
  G.laps.forEach(l=>{if(!curLap[l.driver_number]||l.lap_number>curLap[l.driver_number].lap_number)curLap[l.driver_number]=l;});
  const ldrBest=bestLaps[positions[0]?.driver_number];

  let html=`<div class="scr"><table class="t-table"><thead><tr>
    <th>POS</th><th>DRIVER</th><th>GAP</th><th>BEST</th><th>LAST</th><th>TYR</th><th>LAP</th><th>DRS</th>
  </tr></thead><tbody>`;
  positions.forEach((p,i)=>{
    const d=G.drivers[p.driver_number]||{},car=G.carData[p.driver_number]||{},ld=curLap[p.driver_number]||{};
    const best=bestLaps[p.driver_number],isFast=best&&best===overallBest;
    const pos=p.position,pc=pos===1?'p1c':pos===2?'p2c':pos===3?'p3c':'';
    const col=driverColor(d);
    const gap=i===0?'LEAD':(ldrBest&&best?'+'+((best-ldrBest).toFixed(3))+'s':'â€”');
    const drsOn=(car.drs||0)>=10;
    html+=`<tr><td><span class="pos ${pc}">${pos}</span></td>
      <td><div style="display:flex;align-items:center;gap:6px;">
        <span class="d-num" style="background:${col}22;color:${col};border:1px solid ${col}44;">${p.driver_number}</span>
        <span class="d-name">${d.last_name||d.full_name||'DRV'}</span>
        <span class="d-abbr" style="color:${col};">${d.name_acronym||''}</span>
      </div></td>
      <td class="dim">${gap}</td>
      <td class="${isFast?'fastest':'dim'}">${best?fmtT(best):'â€”'}${isFast?' â—†':''}</td>
      <td class="dim">${ld.lap_duration?fmtT(ld.lap_duration):'â€”'}</td>
      <td>${getTyre(p.driver_number)}</td>
      <td class="dim">${ld.lap_number||'â€”'}</td>
      <td>${drsOn?'<span class="drs-on">DRS</span>':'<span style="color:var(--dim);font-size:.6rem;">â€”</span>'}</td>
    </tr>`;
  });
  html+='</tbody></table></div>';
  body.innerHTML=html;
}

function getTyre(dn) {
  const last=G.pits.filter(p=>p.driver_number===dn).sort((a,b)=>b.lap_number-a.lap_number)[0];
  const c=last?.tyre_compound;
  if(!c) return '<span class="tyre tyre-unknown">?</span>';
  return `<span class="tyre tyre-${c.toLowerCase()}">${c[0]}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRACK MAP (per-window)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTrackPanel(body, win) {
  // Only build the DOM shell if not already there
  if(!body.querySelector('.track-wrap')) {
    body.innerHTML = `
      <div class="track-wrap">
        <canvas class="track-canvas" id="tc-${win.id}"></canvas>
        <div class="track-ctrl">
          <div class="t-zbtn" onclick="trackZoom(${win.id},1.2)">+</div>
          <div class="t-zbtn" onclick="trackZoom(${win.id},0.8)">âˆ’</div>
          <div class="t-zbtn" onclick="trackReset(${win.id})">â†º</div>
        </div>
        <div class="track-loading" id="tl-${win.id}">
          <div class="loader"></div>
          <div class="track-loading-t" id="tlt-${win.id}">LOADING GPS DATA</div>
        </div>
        <div class="track-legend" id="tleg-${win.id}"></div>
      </div>`;
    // Wire up wheel zoom
    const canvas = document.getElementById('tc-'+win.id);
    canvas.addEventListener('wheel', e=>{
      e.preventDefault();
      const f=e.deltaY<0?1.1:0.9;
      const rect=canvas.getBoundingClientRect();
      const mx=e.clientX-rect.left, my=e.clientY-rect.top;
      const ts=win.trackState;
      ts.offX=mx+(ts.offX-mx)*f; ts.offY=my+(ts.offY-my)*f; ts.scale*=f;
      drawTrackOnCanvas(win.id);
    },{passive:false});
    // Wire canvas drag
    let isDrag=false,dragX=0,dragY=0;
    canvas.addEventListener('mousedown',e=>{isDrag=true;dragX=e.clientX;dragY=e.clientY;});
    document.addEventListener('mousemove',e=>{
      if(!isDrag) return;
      win.trackState.panX+=e.clientX-dragX; win.trackState.panY+=e.clientY-dragY;
      dragX=e.clientX; dragY=e.clientY;
      drawTrackOnCanvas(win.id);
    });
    document.addEventListener('mouseup',()=>{isDrag=false;});
    // Touch
    canvas.addEventListener('touchstart',e=>{isDrag=true;dragX=e.touches[0].clientX;dragY=e.touches[0].clientY;},{passive:true});
    canvas.addEventListener('touchmove',e=>{
      if(!isDrag) return;
      win.trackState.panX+=e.touches[0].clientX-dragX; win.trackState.panY+=e.touches[0].clientY-dragY;
      dragX=e.touches[0].clientX; dragY=e.touches[0].clientY;
      drawTrackOnCanvas(win.id);
    },{passive:true});
    canvas.addEventListener('touchend',()=>{isDrag=false;},{passive:true});
  }

  if(G.trackPts.length===0) {
    document.getElementById('tl-'+win.id).style.display='flex';
    const tlt=document.getElementById('tlt-'+win.id);
    if(tlt) tlt.textContent = G.sessionKey ? 'LOADING GPS DATA' : 'LOAD A SESSION';
    return;
  }
  initTrackForWindow(win.id);
}

function initTrackForWindow(id) {
  const w=getWin(id); if(!w) return;
  const canvas=document.getElementById('tc-'+id); if(!canvas) return;
  const wrap=canvas.closest('.track-wrap');
  const W=wrap.clientWidth||400, H=wrap.clientHeight||300;
  canvas.width=W; canvas.height=H;

  const xs=G.trackPts.map(p=>p.x), ys=G.trackPts.map(p=>p.y);
  const mnX=Math.min(...xs),mxX=Math.max(...xs),mnY=Math.min(...ys),mxY=Math.max(...ys);
  const rX=mxX-mnX||1, rY=mxY-mnY||1;
  const pad=50;
  const scX=(W-pad*2)/rX, scY=(H-pad*2)/rY;
  const ts=w.trackState;
  ts.scale=Math.min(scX,scY);
  ts.offX=pad+((W-pad*2)-rX*ts.scale)/2-mnX*ts.scale;
  ts.offY=pad+((H-pad*2)-rY*ts.scale)/2-mnY*ts.scale;
  ts.panX=0; ts.panY=0; ts.inited=true;

  const loading=document.getElementById('tl-'+id);
  if(loading) loading.style.display='none';

  drawTrackOnCanvas(id);
  updateTrackLegend(id);
}

function redrawTrackForWindow(id) {
  const w=getWin(id); if(!w||!w.trackState.inited) return;
  const canvas=document.getElementById('tc-'+id); if(!canvas) return;
  const wrap=canvas.closest('.track-wrap');
  if(!wrap) return;
  // Resize canvas to current container
  const W=wrap.clientWidth, H=wrap.clientHeight;
  if(canvas.width!==W||canvas.height!==H){
    canvas.width=W; canvas.height=H;
    // Re-center
    initTrackForWindow(id);
    return;
  }
  drawTrackOnCanvas(id);
}

function wp2(ts, x, y) {
  return { cx: x*ts.scale+ts.offX+ts.panX, cy: y*ts.scale+ts.offY+ts.panY };
}

function drawTrackOnCanvas(id) {
  const w=getWin(id); if(!w) return;
  const canvas=document.getElementById('tc-'+id); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  const ts=w.trackState;

  ctx.clearRect(0,0,W,H);
  // BG
  const bg=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)/1.4);
  bg.addColorStop(0,'#06101c'); bg.addColorStop(1,'#020408');
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
  // Grid dots
  ctx.fillStyle='rgba(255,255,255,.012)';
  for(let x=0;x<W;x+=25) for(let y=0;y<H;y+=25){ctx.beginPath();ctx.arc(x,y,.8,0,Math.PI*2);ctx.fill();}

  if(G.trackPts.length<4) return;
  const pts=G.trackPts.map(p=>wp2(ts,p.x,p.y));

  const drawPath=(lw,col,close=true)=>{
    ctx.beginPath();
    pts.forEach((p,i)=>i===0?ctx.moveTo(p.cx,p.cy):ctx.lineTo(p.cx,p.cy));
    if(close) ctx.closePath();
    ctx.strokeStyle=col; ctx.lineWidth=lw; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.stroke();
  };
  // Layers
  ctx.shadowColor='rgba(30,80,200,.2)'; ctx.shadowBlur=16;
  drawPath(28,'rgba(25,65,160,.14)');
  ctx.shadowBlur=0;
  drawPath(22,'#243545');
  drawPath(16,'#131d2b');
  ctx.setLineDash([8,8]); drawPath(1.2,'rgba(255,255,255,.04)'); ctx.setLineDash([]);

  // Start/Finish
  if(pts.length>2){
    const p0=pts[0],p1=pts[2];
    const ang=Math.atan2(p1.cy-p0.cy,p1.cx-p0.cx)+Math.PI/2;
    ctx.save(); ctx.translate(p0.cx,p0.cy); ctx.rotate(ang);
    for(let r=0;r<2;r++) for(let c=0;c<3;c++){
      ctx.fillStyle=(r+c)%2===0?'rgba(255,255,255,.85)':'rgba(0,0,0,.7)';
      ctx.fillRect((c-1.5)*4,(r-1)*10,4,10);
    }
    ctx.restore();
  }

  // Driver dots
  const sorted=Object.values(G.driverLocs).sort((a,b)=>b.pos-a.pos);
  sorted.forEach(d=>{
    const{cx,cy}=wp2(ts,d.x,d.y);
    if(cx<-25||cx>W+25||cy<-25||cy>H+25) return;
    const r=6;
    const grd=ctx.createRadialGradient(cx,cy,0,cx,cy,r*3.2);
    grd.addColorStop(0,d.color+'77'); grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(cx,cy,r*3.2,0,Math.PI*2); ctx.fill();
    ctx.shadowColor=d.color; ctx.shadowBlur=10;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle=d.color; ctx.fill();
    ctx.shadowBlur=0;
    ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=1.5; ctx.stroke();
    // Pos badge
    ctx.beginPath(); ctx.arc(cx+r+1,cy-r-1,5,0,Math.PI*2);
    ctx.fillStyle='#020408'; ctx.fill(); ctx.strokeStyle=d.color; ctx.lineWidth=1; ctx.stroke();
    ctx.fillStyle=d.color; ctx.font='bold 5.5px "Share Tech Mono"';
    ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(d.pos,cx+r+1,cy-r-1);
    // Label
    ctx.font='bold 8px "Share Tech Mono"'; ctx.textAlign='center';
    const lw=ctx.measureText(d.abbr).width+7;
    ctx.fillStyle='rgba(2,4,10,.78)'; ctx.fillRect(cx-lw/2,cy-r-18,lw,12);
    ctx.strokeStyle=d.color+'55'; ctx.lineWidth=.7; ctx.strokeRect(cx-lw/2,cy-r-18,lw,12);
    ctx.fillStyle=d.color; ctx.textBaseline='middle'; ctx.fillText(d.abbr,cx,cy-r-12);
  });
}

function updateTrackLegend(id) {
  const leg=document.getElementById('tleg-'+id); if(!leg) return;
  const sorted=Object.values(G.driverLocs).sort((a,b)=>a.pos-b.pos);
  leg.innerHTML=sorted.map(d=>`<div class="leg-item"><div class="leg-dot" style="background:${d.color};box-shadow:0 0 4px ${d.color}88;"></div>${d.abbr}</div>`).join('');
}

function trackZoom(id,f) {
  const w=getWin(id); if(!w) return;
  const canvas=document.getElementById('tc-'+id); if(!canvas) return;
  const cx=canvas.width/2, cy=canvas.height/2;
  const ts=w.trackState;
  ts.offX=cx+(ts.offX-cx)*f; ts.offY=cy+(ts.offY-cy)*f; ts.scale*=f;
  drawTrackOnCanvas(id);
}

function trackReset(id) {
  const w=getWin(id); if(!w) return;
  initTrackForWindow(id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TELEMETRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTelemetry(body) {
  const positions=getLatestPositions();
  if(!positions.length){body.innerHTML=noData('ğŸ“Š','NO DATA','Load a session to view telemetry');return;}
  let html='<div class="scr"><div class="telem-grid">';
  positions.forEach(p=>{
    const d=G.drivers[p.driver_number]||{},car=G.carData[p.driver_number]||{};
    const col=driverColor(d),pos=p.position;
    const dlaps=G.laps.filter(l=>l.driver_number===p.driver_number&&l.lap_duration);
    const best=dlaps.length?Math.min(...dlaps.map(l=>l.lap_duration)):null;
    const thr=car.throttle||0,brk=car.brake||0,gear=car.n_gear||0,rpm=car.rpm||0,spd=car.speed||0;
    const drs=(car.drs||0)>=10;
    html+=`<div class="d-card">
      <div class="d-card-hdr" style="border-left:3px solid ${col};">
        <div class="d-card-num" style="color:${col};">${p.driver_number}</div>
        <div class="d-card-info">
          <div class="d-card-name">${d.last_name||d.full_name||'DRV '+p.driver_number}</div>
          <div class="d-card-team" style="color:${col}88;">${d.team_name||'â€”'}</div>
        </div>
        <div class="d-card-pos ${pos===1?'p1c':''}">P${pos}</div>
      </div>
      <div class="bars">
        <div class="bar-row"><div class="bar-lbl"><span>THROTTLE</span><span class="bar-val">${thr}%</span></div><div class="bar-track"><div class="bar-fill bt" style="width:${thr}%"></div></div></div>
        <div class="bar-row"><div class="bar-lbl"><span>BRAKE</span><span class="bar-val">${brk}%</span></div><div class="bar-track"><div class="bar-fill bb" style="width:${brk}%"></div></div></div>
        <div class="bar-row"><div class="bar-lbl"><span>GEAR</span><span class="bar-val">${gear}/8</span></div><div class="bar-track"><div class="bar-fill bg" style="width:${(gear/8)*100}%"></div></div></div>
        <div class="bar-row"><div class="bar-lbl"><span>RPM</span><span class="bar-val">${rpm.toLocaleString()}</span></div><div class="bar-track"><div class="bar-fill br" style="width:${Math.min((rpm/15000)*100,100)}%"></div></div></div>
      </div>
      <div class="d-stats">
        <div class="s-box"><div class="s-val">${spd}</div><div class="s-lbl">KM/H</div></div>
        <div class="s-box"><div class="s-val">${best?fmtT(best):'â€”'}</div><div class="s-lbl">BEST LAP</div></div>
        <div class="s-box"><div class="s-val" style="color:${drs?'var(--green)':''}">${drs?'ON':'OFF'}</div><div class="s-lbl">DRS</div></div>
        <div class="s-box"><div class="s-val">${dlaps.length}</div><div class="s-lbl">LAPS</div></div>
        <div class="s-box"><div class="s-val">${d.name_acronym||'â€”'}</div><div class="s-lbl">CODE</div></div>
        <div class="s-box"><div class="s-val">${G.pits.filter(pt=>pt.driver_number===p.driver_number).length}</div><div class="s-lbl">STOPS</div></div>
      </div>
    </div>`;
  });
  html+='</div></div>';
  body.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STANDINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStandings(body) {
  const na=noData('ğŸ“­','NOT AVAILABLE','Championship data is only available for race sessions');
  if(!G.driverStandings.length&&!G.teamStandings.length){body.innerHTML=na;return;}
  let html='<div class="scr">';
  if(G.driverStandings.length){
    const mx=Math.max(...G.driverStandings.map(d=>d.points||0));
    html+=`<div style="padding:8px 12px;font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.18em;color:var(--dim);border-bottom:1px solid var(--border);">DRIVER CHAMPIONSHIP</div>`;
    html+=G.driverStandings.sort((a,b)=>(a.position||99)-(b.position||99)).map(s=>{
      const d=G.drivers[s.driver_number]||{},col=driverColor(d),pos=s.position,pc=pos===1?'p1c':pos===2?'p2c':pos===3?'p3c':'';
      return `<div class="stand-row"><span class="pos ${pc}">${pos}</span>
        <span class="d-num" style="background:${col}22;color:${col};border:1px solid ${col}44;padding:1px 5px;border-radius:2px;font-family:'Orbitron',monospace;font-size:.66rem;">${d.name_acronym||'DRV'}</span>
        <span class="d-name" style="flex:1;">${d.last_name||'#'+s.driver_number}</span>
        <div class="pts-track"><div class="pts-fill" style="width:${mx?(s.points/mx)*100:0}%"></div></div>
        <span class="pts-val">${s.points}</span></div>`;
    }).join('');
  }
  if(G.teamStandings.length){
    const mx=Math.max(...G.teamStandings.map(t=>t.points||0));
    html+=`<div style="padding:8px 12px;margin-top:8px;font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.18em;color:var(--dim);border-bottom:1px solid var(--border);">CONSTRUCTOR CHAMPIONSHIP</div>`;
    html+=G.teamStandings.sort((a,b)=>(a.position||99)-(b.position||99)).map(s=>{
      const col=teamColor(s.team_name),pos=s.position,pc=pos===1?'p1c':pos===2?'p2c':pos===3?'p3c':'';
      return `<div class="stand-row"><span class="pos ${pc}">${pos}</span>
        <div style="width:8px;height:8px;border-radius:50%;background:${col};flex-shrink:0;"></div>
        <span class="d-name" style="flex:1;">${s.team_name||'Team'}</span>
        <div class="pts-track"><div class="pts-fill" style="width:${mx?(s.points/mx)*100:0}%;background:linear-gradient(90deg,${col},${col}88);"></div></div>
        <span class="pts-val">${s.points}</span></div>`;
    }).join('');
  }
  html+='</div>';
  body.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLaps(body, win) {
  if(!G.laps.length){body.innerHTML=noData('â±','NO LAP DATA');return;}

  // Build driver select options
  const drivers=[...new Set(G.laps.map(l=>l.driver_number))];
  const selOpts='<option value="">All</option>'+drivers.map(n=>{
    const d=G.drivers[n]||{};
    return `<option value="${n}" ${win.lapFilter==n?'selected':''}>${(d.name_acronym||'DRV')} #${n}</option>`;
  }).join('');

  const filt=win.lapFilter;
  let laps=G.laps.filter(l=>!filt||l.driver_number==filt).sort((a,b)=>a.driver_number-b.driver_number||a.lap_number-b.lap_number);
  const fastest=Math.min(...laps.filter(l=>l.lap_duration).map(l=>l.lap_duration));

  let html=`<div style="display:flex;flex-direction:column;height:100%;">
    <div class="lap-hdr">
      <span style="font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.15em;color:var(--dim);">DRIVER</span>
      <select class="drv-sel" onchange="setLapFilter(${win.id},this.value)">${selOpts}</select>
    </div>
    <div class="scr" style="flex:1;">
    <table class="t-table"><thead><tr>
      <th>DRV</th><th>LAP</th><th>TIME</th><th>S1</th><th>S2</th><th>S3</th><th>V MAX</th>
    </tr></thead><tbody>`;
  laps.forEach(l=>{
    const d=G.drivers[l.driver_number]||{},col=driverColor(d);
    const isFast=l.lap_duration&&l.lap_duration===fastest;
    html+=`<tr><td>
      <div style="display:flex;align-items:center;gap:5px;">
        <span style="width:6px;height:6px;border-radius:50%;background:${col};display:inline-block;flex-shrink:0;"></span>
        <span class="d-abbr" style="color:${col};">${d.name_acronym||'DRV'}</span>
      </div></td>
      <td class="dim">${l.lap_number}</td>
      <td class="${isFast?'fastest':'dim'}">${l.lap_duration?fmtT(l.lap_duration):'â€”'}${isFast?' â—†':''}</td>
      <td class="dim" style="font-size:.68rem;">${l.duration_sector_1?fmtT(l.duration_sector_1):'â€”'}</td>
      <td class="dim" style="font-size:.68rem;">${l.duration_sector_2?fmtT(l.duration_sector_2):'â€”'}</td>
      <td class="dim" style="font-size:.68rem;">${l.duration_sector_3?fmtT(l.duration_sector_3):'â€”'}</td>
      <td class="dim">${l.st_speed?l.st_speed+'km/h':'â€”'}</td></tr>`;
  });
  html+='</tbody></table></div></div>';
  body.innerHTML=html;
}

function setLapFilter(winId, val) {
  const w=getWin(winId); if(!w) return;
  w.lapFilter=val;
  renderWindow(winId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIT STOPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPits(body) {
  if(!G.pits.length){body.innerHTML=noData('ğŸ”§','NO PIT DATA');return;}
  let html='<div class="scr"><table class="t-table"><thead><tr><th>DRIVER</th><th>LAP</th><th>DURATION</th><th>COMPOUND</th></tr></thead><tbody>';
  [...G.pits].sort((a,b)=>a.lap_number-b.lap_number).forEach(p=>{
    const d=G.drivers[p.driver_number]||{},col=driverColor(d),c=p.tyre_compound;
    html+=`<tr><td><div style="display:flex;align-items:center;gap:5px;">
      <span style="width:6px;height:6px;border-radius:50%;background:${col};display:inline-block;"></span>
      <span class="d-abbr" style="color:${col};">${d.name_acronym||'DRV'}</span>
      <span class="dim" style="font-size:.68rem;">${d.last_name||'#'+p.driver_number}</span>
    </div></td>
    <td style="font-family:'Orbitron',monospace;font-size:.75rem;color:var(--cyan);">L${p.lap_number||'?'}</td>
    <td style="font-family:'Share Tech Mono';color:var(--gold);">${p.pit_duration?p.pit_duration.toFixed(1)+'s':'â€”'}</td>
    <td>${c?`<span class="tyre tyre-${c.toLowerCase()}">${c[0]}</span> <span class="dim" style="font-size:.7rem;">${c}</span>`:'â€”'}</td></tr>`;
  });
  html+='</tbody></table></div>';
  body.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEATHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWeather(body) {
  const w=G.weather[G.weather.length-1];
  if(!w){body.innerHTML=noData('ğŸŒ¤','NO WEATHER DATA');return;}
  const boxes=[
    {icon:'ğŸŒ¡',lbl:'AIR TEMP',val:(w.air_temperature||'â€”')+'Â°C',col:'#ff8060'},
    {icon:'ğŸ',lbl:'TRACK',val:(w.track_temperature||'â€”')+'Â°C',col:'#ff4500'},
    {icon:'ğŸ’¨',lbl:'WIND',val:(w.wind_speed||'â€”')+' m/s',col:'#00cfff'},
    {icon:'ğŸ§­',lbl:'DIR',val:(w.wind_direction||'â€”')+'Â°',col:'#7a9ab0'},
    {icon:'ğŸ’§',lbl:'HUMIDITY',val:(w.humidity||'â€”')+'%',col:'#00cfff'},
    {icon:'ğŸŒ§',lbl:'RAIN',val:w.rainfall?'YES':'NO',col:w.rainfall?'#00cfff':'#4a6580'},
    {icon:'ğŸ“Š',lbl:'PRESSURE',val:(w.pressure||'â€”')+' mb',col:'#c77dff'},
  ];
  let html=`<div class="scr">
    <div style="padding:8px 12px;font-size:.65rem;color:var(--dim);font-family:'Share Tech Mono';">LAST READING: ${w.date?new Date(w.date).toLocaleTimeString():'â€”'} &nbsp;Â·&nbsp; ${G.weather.length} readings</div>
    <div class="wx-grid">`;
  html+=boxes.map(b=>`<div class="wx-box"><div class="wx-icon">${b.icon}</div><div class="wx-lbl">${b.lbl}</div><div class="wx-val" style="color:${b.col};">${b.val}</div></div>`).join('');
  html+='</div></div>';
  body.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RACE CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRaceControl(body) {
  if(!G.raceControl.length){body.innerHTML=noData('ğŸ“»','NO MESSAGES');return;}
  const FE={'GREEN':'ğŸŸ¢','YELLOW':'ğŸŸ¡','RED':'ğŸ”´','SAFETY CAR':'ğŸš—','VIRTUAL SAFETY CAR':'ğŸŸ¡','CHEQUERED':'ğŸ','BLUE':'ğŸ”µ'};
  let html='<div class="scr">';
  html+=[...G.raceControl].sort((a,b)=>b.date>a.date?1:-1).map(rc=>{
    const cat=(rc.category||'info').toLowerCase();
    const cc=cat.includes('flag')?'rc-flag':cat.includes('incident')?'rc-inc':'rc-info';
    const fe=rc.flag?(FE[rc.flag]||'ğŸš©'):'';
    return `<div class="rc-item">
      <div class="rc-time">${rc.date?new Date(rc.date).toLocaleTimeString():'â€”'}</div>
      <div style="flex:1;">
        <div style="display:flex;gap:5px;align-items:center;margin-bottom:3px;">
          <span class="rc-cat ${cc}">${rc.category||'INFO'}</span>
          ${fe?`<span style="font-size:.9rem;">${fe}</span>`:''}`+
          (rc.flag?`<span style="font-size:.62rem;color:var(--dim);">${rc.flag}</span>`:'')
        +`</div>
        <div class="rc-msg">${rc.message||'â€”'}</div>
        ${rc.driver_number?`<div style="font-size:.65rem;color:var(--dim);margin-top:2px;">Driver #${rc.driver_number}${rc.lap_number?' Â· Lap '+rc.lap_number:''}</div>`:''}
      </div>
    </div>`;
  }).join('');
  html+='</div>';
  body.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE OBSERVER for track canvas
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(typeof ResizeObserver !== 'undefined') {
  const ro = new ResizeObserver(entries => {
    entries.forEach(entry => {
      const body = entry.target;
      const winEl = body.closest('.win');
      if(!winEl) return;
      const id = parseInt(winEl.dataset.winId);
      const w = getWin(id);
      if(w && w.type==='track' && w.trackState.inited) {
        clearTimeout(w._resizeTimer);
        w._resizeTimer = setTimeout(()=>redrawTrackForWindow(id), 80);
      }
    });
  });
  // Observe all win-body elements as windows are added
  const wsObs = new MutationObserver(muts => {
    muts.forEach(m => m.addedNodes.forEach(n => {
      if(n.classList && n.classList.contains('win')) {
        const body = n.querySelector('.win-body');
        if(body) ro.observe(body);
      }
    }));
  });
  wsObs.observe(document.getElementById('workspace'), {childList:true});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildPicker();
loadSessions();

// Spawn default layout
window.addEventListener('load', () => {
  const ws = document.getElementById('workspace');
  const W = ws.clientWidth, H = ws.clientHeight;
  const pad = 6;
  const hw = Math.floor((W-pad*3)/2), hh = Math.floor((H-pad*3)/2);
  spawnWindow('timing',    pad,       pad,       hw, hh);
  spawnWindow('track',     hw+pad*2,  pad,       hw, hh);
  spawnWindow('telemetry', pad,       hh+pad*2,  hw, hh);
  spawnWindow('weather',   hw+pad*2,  hh+pad*2,  hw, hh);
});
</script>
</body>
</html>
